 version: 2

 references:
   install_docker: &install_docker
     run:
        name: Install Docker client
        command: |
          set -x
          VER="17.03.0-ce"
          curl -L -o /tmp/docker-$VER.tgz https://download.docker.com/linux/static/stable/x86_64/docker-$VER.tgz
          tar -xz -C /tmp -f /tmp/docker-$VER.tgz
          mv /tmp/docker/* /usr/bin
    
   arm64_support: &arm64_support
      run:
        name: Arm64 support
        command: docker run --rm --privileged multiarch/qemu-user-static:register #support for arm64 docker images (see: https://ownyourbits.com/2018/06/27/running-and-building-arm-docker-containers-in-x86/)


 jobs:
   
   build:
     docker:
       - image: circleci/cci-demo-docker-primary:0.0.2
     steps:
       - checkout
       - *install_docker
       - *arm64_support
       - setup_remote_docker:   #see: https://circleci.com/docs/2.0/building-docker-images/
          docker_layer_caching: true 
       - run: 
            name: Build arm64 Docker image
            command: docker build -t "rio05docker/web_server_panel:rpi3_test_${CIRCLE_SHA1}" ~/project/startbootstrap-shop-item-gh-pages/
       #- save_cache:
       #     key: test_cache
       #     paths:
       #       - ~/project/vendor

   test:
    docker:
       - image: circleci/cci-demo-docker-primary:0.0.2
    steps:
       - checkout
       - *install_docker
       - *arm64_support
       #- restore_cache: { keys: [ test_cache ] }
       - setup_remote_docker:   #see: https://circleci.com/docs/2.0/building-docker-images/
          docker_layer_caching: true 
       - run: 
          name: Test container 
          command: |
            docker build -t "rio05docker/web_server_panel:rpi3_test_${CIRCLE_SHA1}" ~/project/startbootstrap-shop-item-gh-pages/
            docker run --rm rio05docker/web_server_panel:rpi3_test_${CIRCLE_SHA1}
   
   push:
    docker:
        - image: circleci/cci-demo-docker-primary:0.0.2
    steps:
        - checkout
        - setup_remote_docker:   #see: https://circleci.com/docs/2.0/building-docker-images/
           docker_layer_caching: true 
        - *install_docker
        - *arm64_support
        #- restore_cache: { keys: [ test_cache ] }
        - run: 
            name: Push arm64 Docker image
            command: | 
              docker build -t "rio05docker/web_server_panel:rpi3_test_${CIRCLE_SHA1}" ~/project/startbootstrap-shop-item-gh-pages/
              docker push rio05docker/web_server_panel:rpi3_test_${CIRCLE_SHA1}


   deploy_nodes:
    docker:
      - image: circleci/cci-demo-docker-primary:0.0.2
    environment:
        NODE_HOSTNAME: raspberrypi
    steps:
      - checkout
      #- run: kubernetes/lamp/build.sh
      #- run: kubernetes/lamp/build.sh

 workflows:
    version: 2
    steps:
      jobs:
        - build: { filters: { branches: { only: [ test ] } } }
        - test: { requires: [ build ] }
        - push: { requires: [ test ] }
        - deploy_nodes: { requires: [ push ] } #TODO: need to deploy to local k8s cluster!!


